---
##################
# Install Legion Airflow
##################

# Deploy airflow to legion cluster.
# Create aws resources if will be needed.

# NOTICE:
# You Must specify the next variables as extra vars (--extra-vars "XXXX=YYYY") 
# profile - unique cluster name
# legion_airflow_version - Legion-airflow version to deploy
# Optional arguments:
# docker_repo - rewrite docker registry endpoint
# enclave_name - enclave name


- hosts: localhost
  connection: local
  gather_facts: True

  vars_files:
#    - "{{ lookup('env', 'PROFILES_PATH') or '../profiles' }}/{{ profile }}.yml"
    - vars/common-vars.yaml

  pre_tasks:
    - name: Download secrets from S3
      aws_s3:
        bucket: "{{ secrets_bucket }}"
        object: "vault/airflow_secrets.yaml"
        dest: "airflow_secrets.yaml"
        mode: get

    - name: Include vars
      include_vars:
        file: "airflow_secrets.yaml"

    - name: If enclave_name var will be passed than deploy airflow to this specific enclave
      set_fact: enclaves=[{{ enclave_name }}]
      when: enclave_name is defined and enclave_name | trim != ''

  post_tasks:
    - name: Delete secrets file
      file:
        name: "airflow_secrets.yaml"
        state: absent
  
  roles:
    - commons
    - helm
    - aws_resources
#    - k8s_resources

  tasks:
    - include_role:
        name: legion_airflow
      with_items: "{{ enclaves }}"
      loop_control:
        loop_var: enclave
